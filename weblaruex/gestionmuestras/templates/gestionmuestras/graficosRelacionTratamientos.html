{% extends "base/base_gestmues.html" %}
{% load static %}
{% block title %}
    Web LARUEX
{% endblock %}
{% block imports %}
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/networkgraph.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>
{% endblock %}

{% block css %}
    button, input[type="submit"], input[type="reset"] {
        background: none;
        color: inherit;
        border: none;
        padding: 0;
        font: inherit;
        cursor: pointer;
        outline: inherit;
    }
    .param-adicional div:hover{
        background-color: #D7E9FC;
    }
    .highcharts-figure,
    .highcharts-data-table table {
        min-width: 320px;
        max-width: 800px;
        margin: 1em auto;
    }

    .highcharts-data-table table {
        font-family: Verdana, sans-serif;
        border-collapse: collapse;
        border: 1px solid #ebebeb;
        margin: 10px auto;
        text-align: center;
        width: 100%;
        max-width: 500px;
    }

    .highcharts-data-table caption {
        padding: 1em 0;
        font-size: 1.2em;
        color: #555;
    }

    .highcharts-data-table th {
        font-weight: 600;
        padding: 0.5em;
    }

    .highcharts-data-table td,
    .highcharts-data-table th,
    .highcharts-data-table caption {
        padding: 0.5em;
    }

    .highcharts-data-table thead tr,
    .highcharts-data-table tr:nth-child(even) {
        background: #f8f8f8;
    }

    .highcharts-data-table tr:hover {
        background: #f1f7ff;
    }
{% endblock %}

{% block content %}
<div class="pagetitle">
    <nav>
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{% url 'gestionmuestras:gestmuesOpciones' %}">Home</a></li>
        </ol>
    </nav>
</div>
<!-- Info programa -->
<section class="section dashboard">
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Relación de las muestras dentro del LARUEX</h5>
            <div class="row">
                <div class="col-lg-4 col-md-3 col-sm-12">
                    <form class="g-3" action="{% url 'gestionmuestras:gestmuesGraficosRelacionesTratamientos' %}" method="POST"> 
                        {% csrf_token %}
                        <!--select con las opciones de la lista determinaciones -->
                        <div class="param-adicional mb-3">
                            <label for="determinacion" class="form-label">Determinación</label>
                            <select class="form-select" id="determinacion" name="determinacion">
                                <option value="0">Seleccione una determinación</option>
                                {% for determinacion in determinaciones %}
                                    <option value="{{ determinacion.identificador }}">{{ determinacion.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="btn btn-outline-primary">Filtrar</button>
                        <a href="{% url 'gestionmuestras:gestmuesGraficosRelacionesTratamientos' %}" class="btn btn-outline-primary">Resetear</a>
                    </form>
                </div>
                <div class="col-lg-8 col-md-9 col-sm-12">
                    <figure class="highcharts-figure">
                        <div id="container"></div>
                        <p class="highcharts-description">
                        Este grafo muestra la relación de las distintas muestras con los tratamientos en el laboratorio.
                        </p>
                    </figure>
                </div>
            </div>

        </div>
    </div>
</section>
<!-- End Info programa -->

<script>
   // Add the nodes option through an event call. We want to start with the parent
// item and apply separate colors to each child element, then the same color to
// grandchildren.
Highcharts.addEvent(
    Highcharts.Series,
    'afterSetOptions',
    function (e) {

        const colors = Highcharts.getOptions().colors,
            nodes = {};
        
        let i = 0;

        if (
            this instanceof Highcharts.Series.types.networkgraph &&
            e.options.id === 'lang-tree'
        ) {
            e.options.data.forEach(function (link) {

                if (link[0] === 'Muestra') {
                    nodes['Muestra'] = {
                        id: 'Muestra',
                        marker: {
                            radius: 20
                        },
                        color: colors[1]
                    };
                    nodes[link[1]] = {
                        id: link[1],
                        marker: {
                            radius: 10
                        },
                        color: colors[2]
                    };
                }
            });

            e.options.nodes = Object.keys(nodes).map(function (id) {
                return nodes[id];
            });
        }
    }
);

Highcharts.chart('container', {
    chart: {
        type: 'networkgraph',
        height: '100%'
    },
    title: {
        text: 'Gestión de Muestras - LARUEX',
        align: 'left'
    },
    subtitle: {
        text: 'Grafo de relación de las muestras con las determinaciones y los tratamientos en el laboratorio.',
        align: 'left'
    },
    plotOptions: {
        networkgraph: {
            keys: ['from', 'to'],
            layoutAlgorithm: {
                enableSimulation: true,
                friction: -0.9
            }
        }
    },
    series: [{
        accessibility: {
            enabled: false
        },
        dataLabels: {
            enabled: true,
            linkFormat: '',
            style: {
                fontSize: '0.8em',
                fontWeight: 'normal'
            }
        },
        id: 'lang-tree',
        data: {{ datos|safe }}
    }]
});

</script>
{% endblock %}

{% extends "base/base_gestmues.html" %}
{% load static %}
{% block title %}
    Web LARUEX
{% endblock %}
{% block imports %}
{% endblock %}

{% block css %}
{% endblock %}

{% block content %}

<!-- modal confirm delete cod muestra -->
<div class="modal fade" id="modalConfirmDeleteCodMuestra" tabindex="-1" aria-labelledby="modalConfirmDeleteCodMuestraLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalConfirmDeleteCodMuestraLabel">Eliminar Código Muestra</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                ¿Está seguro que desea eliminar el código de muestra?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="confirmarBorrado()">Eliminar</button>
            </div>
        </div>
    </div>
</div>
<!-- end modal confirm delete cod muestra -->

<!-- modal to add or edit a cod muestra -->
<div class="modal fade" id="modalAddEditCodMuestra" tabindex="-1" aria-labelledby="modalAddEditCodMuestraLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalAddEditCodMuestraLabel">Nuevo Código Muestra</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div id="formModal" class="modal-body">
                
            </div>
        </div>
    </div>
</div>
<!-- end modal to add or edit a cod muestra -->

<div class="pagetitle">
    <nav>
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'gestionmuestras:gestmuesOpciones' %}">Home</a></li>
        </ol>
    </nav>
</div>
<!-- Info programa -->
<section class="section dashboard">
    <!-- Info programa cards -->
    <div class="col-12" class="table-responsive">
        <table class="table"
            id="table"
            data-toggle="table"
            data-pagination="true"
            data-page-size="25"
            data-height="800"
            data-search="true"
            data-show-columns="true"
            data-show-refresh="true"
            data-show-columns-toggle-all="true"
            data-show-fullscreen="true"
            data-buttons="buttons"
            data-buttons-class="light"
            data-show-export="true"
            data-url="/private/gestionmuestras/gestionMuestraActualCodigoDatos/">
        </table>
    </div>
    <!-- End Grid cards -->
</section>
<!-- End Info programa -->

<script>
    // tabla para mostrar la informacion de la muestra actual y codigos
    // parametros:  codigo, posicion, duplicada, duplicada_pos, control, control_pos, blanco, blanco_pos, tiempo_en_lab
    $('#table').bootstrapTable({
        columns: [
            {
                title: 'ID',	
                sortable: 'true',
                field: 'id'
            },
            {
                title: 'CÓDIGO',	
                sortable: 'true',
                field: 'codigo'
            },
            {
                title: 'POSICIÓN',	
                sortable: 'true',
                field: 'posicion'
            },
            {
                title: 'DUPLICADA',	
                sortable: 'true',
                field: 'duplicada'
            },
            {
                title: 'POSICIÓN DUPLICADA',	
                sortable: 'true',
                field: 'duplicada_pos'
            },
            {
                title: 'CONTROL',	
                sortable: 'true',
                field: 'control'
            },
            {
                title: 'POSICIÓN CONTROL',	
                sortable: 'true',
                field: 'control_pos'
            },
            {
                title: 'BLANCO',	
                sortable: 'true',
                field: 'blanco'
            },
            {
                title: 'POSICIÓN BLANCO',	
                sortable: 'true',
                field: 'blanco_pos'
            },
            {
                title: 'TIEMPO EN LAB',	
                sortable: 'true',
                field: 'tiempo_en_lab'
            }
            ,{
                title: 'Acciones',
                formatter: function (value, row) {
                  // si usuario es administrador
                  let botones = '<div class="btn-group">';
                  botones += '<a class="btn" onclick="editarCodigo('+"'"+row.id+"'"+')"><i class="fa-solid fa-pen-to-square"></i></a>';
                  
                  {% if user.is_superuser %}
                    botones += '<a class="btn" onclick="borrarCodigo('+"'"+row.id+"'"+')"><i class="fa-solid fa-trash"></i></a>';
                  {% endif %}
                  botones += '</div>';
                  return botones;
                }
            }],
        locale: "es-ES",
        search: true,
        sortName: 'doc',
        sortOrder: 'asc',
        exportDataType: "",
        exportTypes: ['pdf', 'xml', 'csv', 'json'],
    })

    function dateFormat(value, row, index) {
        return moment(value).format('DD/MM/YYYY HH:mm');
    }

    function buttons () {
        return {
          btnAdd: {
            text: 'Nuevo Código Muestra',
            icon: 'bi-plus',
            event: function () {
                $.ajax({
                url: '/private/gestionmuestras/gestionMuestraActualCodigoNuevo/',
                type: 'GET',
                success: function(response){
                    $('#formModal').html(response);
                    $('#modalAddEditCodMuestra').modal('show');
                },
                error: function(error){
                    console.log(error);
                }
            });
            },
            attributes: {
              title: 'Nuevo Código Muestra',
            }
          }
        }
    }
    let codigoAuxiliar = "";
    function borrarCodigo(codigo){
        codigoAuxiliar = codigo;
        $('#modalConfirmDeleteCodMuestra').modal('show');
    }
    function confirmarBorrado(){
        $('#modalConfirmDeleteCodMuestra').modal('hide');
        $.ajax({
            url: '/private/gestionmuestras/gestionMuestraActualCodigoBorrar/',
            type: 'POST',
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}', 'codigo': codigoAuxiliar
            },
            success: function(response){
                $('#table').bootstrapTable('refresh');
            },
            error: function(error){
                console.log(error);
            }
        });
    }
    function editarCodigo(codigo){
        $.ajax({
            url: '/private/gestionmuestras/gestionMuestraActualCodigoEditar/',
            type: 'POST',
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}', 
                'consulta': 1,
                'codigo': codigo
            },
            success: function(response){
                $('#formModal').html(response);
                $('#modalAddEditCodMuestra').modal('show');
            },
            error: function(error){
                console.log(error);
            }
        });
    }
</script>
{% endblock %}

{% extends "base/base_spd.html" %}

{% load static %}

{% block imports %}

<!-- Mapa Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
  integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
  crossorigin="" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
  integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
  crossorigin=""></script>
<!--<script src='http://cdn.leafletjs.com/leaflet/v1.3.1/leaflet.js'></script>
<link href='http://cdn.leafletjs.com/leaflet/v1.3.1/leaflet.css' rel='stylesheet' />-->

<!-- ContextMenu (Click boton derecho sobre el mapa) -->
<!-- https://github.com/aratcliffe/Leaflet.contextmenu -->
<link rel="stylesheet" type="text/css" href="{% static 'css/spd/leaflet-contextmenu.css' %}">
<script type="text/javascript" src="{% static 'js/spd/leaflet-contextmenu.js' %}"></script>

<!-- Leaflet Sidebar -->
<!-- https://github.com/noerw/leaflet-sidebar-v2 -->
<link rel="stylesheet" type="text/css" href="{% static 'css/spd/leaflet-sidebar.css' %}">
<script type="text/javascript" src="{% static 'js/spd/leaflet-sidebar.js' %}"></script>

<!-- Extra Markers -->
<!-- https://github.com/coryasilva/Leaflet.ExtraMarkers -->
<link rel="stylesheet" type="text/css" href="{% static 'css/spd/leaflet-extra-markers.min.css' %}">
<script type="text/javascript" src="{% static 'js/spd/leaflet-extra-markers.min.js' %}"></script>

<!-- Fluid water animation -->
<!--https://www.cssscript.com/liquid-progress-indicator/-->
<script src="{% static 'js/spida/js-fluid-meter.js' %}"></script>

<!-- Control search (buscador de markers)-->
<link rel="stylesheet" type="text/css" href="{% static 'css/spd/leaflet-search.css' %}" />
<script src="{% static 'js/spd/leaflet-search.js' %}"></script>

<!-- Control Full Screen -->
<link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css'
  rel='stylesheet' />
<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>

<!-- Control Navbar (Boton Homey avanzar o retroceder movimientos historicos) -->
<!--https://github.com/davidchouse/Leaflet.NavBar-->
<link rel="stylesheet" type="text/css" href="{% static 'css/spd/leaflet-navbar.css' %}">

<!-- Control Exportar mapa como imagen (Print map) -->
<!--https://github.com/rowanwins/leaflet-easyPrint-->
<!--<script type="text/javascript" src="{% static 'js/spd/leaflet-bundle-easyprint.js' %}"></script>-->
<!--<script type="text/javascript" src="{% static 'js/spd/bundle-print.js' %}"></script>-->
<!--<link rel="stylesheet" href="{% static 'css/spd/leaflet-BigImage-min.css' %}">
<script src="{% static 'js/spd/leaflet-BigImage-min.js' %}"></script>-->

<!-- Pulse icon (Alarmas)-->
<link rel="stylesheet" type="text/css" href="{% static 'css/spd/leaflet-icon-pulse.css' %}" />
<script src="{% static 'js/spd/leaflet-icon-pulse.js' %}"></script>

<!-- Time Dimension (Imagenes Prediccion Precipitacion 1 h Aemet)-->
<!-- https://github.com/socib/Leaflet.TimeDimension -->
<link rel="stylesheet" type="text/css" href="{% static 'css/spd/leaflet-timedimension-control.css' %}" />
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/iso8601-js-period@0.2.1/iso8601.min.js"></script>
<script src="{% static 'js/spd/leaflet-timedimension.js' %}"></script>
<script src="{% static 'js/spd/leaflet-timedimension-util.js' %}"></script>
<script src="{% static 'js/spd/leaflet-timedimension-layer.js' %}"></script>
<script src="{% static 'js/spd/leaflet-timedimension-layer-wms.js' %}"></script>
<script src="{% static 'js/spd/leaflet-timedimension-layer-geojson.js' %}"></script>
<script src="{% static 'js/spd/leaflet-timedimension-player.js' %}"></script>
<script src="{% static 'js/spd/leaflet-timedimension-control.js' %}"></script>
<script src="{% static 'js/spd/leaflet-timedimension-control-map.js' %}"></script>

<!-- Control Panel Layers -->
<link rel="stylesheet" type="text/css" href="{% static 'css/spd/leaflet-panel-layers.css' %}" />
<script src="{% static 'js/spd/leaflet-panel-layers.js' %}"></script>

<!--Plugin CSS file with desired skin Para opacidad de capas wms-->
<link rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.3.1/css/ion.rangeSlider.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.3.1/js/ion.rangeSlider.min.js"></script>

<!--Control Info Avisos -->
<script src="{% static 'js/spida/L.Control.Info.js' %}"></script>

<!-- Control Leyenda -->
<!--<link rel="stylesheet" type="text/css" href="{% static 'css/spd/leaflet-legend.css' %}" />
<script src="{% static 'js/spd/leaflet-legend.js' %}"></script>-->

<!--Imprimir mapa
https://github.com/Igor-Vladyka/leaflet.browser.print-->
<!--<script src="{% static 'js/spd/leaflet-print-map.js' %}"></script>
<script type="text/javascript" src="{% static 'js/spd/leaflet-print-map-png.js' %}"></script>-->

<!--Layer Imagenes Spida -->
<link rel="stylesheet" type="text/css" href="{% static 'css/spd/leaflet-photo.css' %}" />

<!-- MarkersCluster -->
<link rel="stylesheet" href="http://leaflet.github.io/Leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="http://leaflet.github.io/Leaflet.markercluster/dist/MarkerCluster.Default.css" />
<script src="http://leaflet.github.io/Leaflet.markercluster/dist/leaflet.markercluster-src.js"></script>

<!-- Leaflet Spin -->
<!-- https://github.com/makinacorpus/Leaflet.Spin -->
<script src="{% static 'js/spd/spin.min.js' %}" charset="utf-8"></script>
<script src="{% static 'js/spd/leaflet.spin.min.js' %}" charset="utf-8"></script>

<!-- Para invertir el area de relleno de un poligono o capa json del mapa-->
<!--https://github.com/ebrelsford/Leaflet.snogylop-->
<script type="text/javascript" src="{% static 'js/spd/leaflet-snogylop.js' %}"></script>

<!-- Custom css mapa -->
<link rel="stylesheet" type="text/css" href="{% static 'css/spd/mapa_spd.css' %}" />

<!-- Gradient cards Nivel Rio de una estación -->
<link rel="stylesheet" type="text/css" href="{% static 'css/spd/gradient_cards.css' %}" />

<!-- Custom css Graficos Highcharts  -->
<link rel="stylesheet" type="text/css" href="{% static 'css/spd/highcharts_spd.css' %}" />

<!-- Capas Shapefiles -->
<script type="text/javascript" src="{% static 'js/spd/shapefiles/aemet.js' %}"></script>
<script type="text/javascript" src="{% static 'js/spd/shapefiles/extremadura.js' %}"></script>

<!--<script type="text/javascript" src="{% static 'js/gl-particles.js' %}"></script>-->

<style>
  /*-----------------------------------------------------------------------
#Cuadro de Info Avisos
------------------------------------------------------------------------*/
  /*.leaflet-control-layers.leaflet-control.contentStyle {
    max-height: 500px;
    margin-left: 10px;
  }

  #title-aviso {
    font-family: 'Roboto', sans-serif;
    font-weight: bold;
    font-size: 20px;
    color: #fff;
    margin: 0px;
  }

  #cabecera-aviso {
    color: #00CED1;
    font-family: 'Brush Script MT', cursive;
    font-size: 30px;
  }

  .titleStyle {
    background-color: rgba(52, 58, 64, 0.6);
    right: 45px;
    top: 35px;
  }

  .contentStyle {
    //background-color: rgba(245, 245, 245, 0.8);
    background-color: rgba(52, 58, 64, 0.6);
    font-size: 13px;
    color: #fff;
    text-align: justify;
  }

  .leaflet-popup-content-wraper {
    max-height: 500px;
    overflow: auto;
    right: 45px;
  }


  #recaptcha>div {
    margin: 0 auto .5em;
  }


  [contentEditable=true]:empty:not(:focus):before {
    content: attr(data-text)
  }*/
</style>

{% endblock %}


{% block content %}

<!-- Mapa Leaflet-->
<div id="map"></div>
<!-- END Mapa Leaflet-->

<!-- Logos -->
<div id="logos" class="logos">
  <div class="row row-logos">
    <div class=" col-3 d-flex align-items-center justify-content-center"
      style="width:100%; height:100%;padding:0; margin:0">
      <img src="{% static 'img/spd/logos/logo_laruex.png' %}" alt="">
    </div>
    <div class=" col-3 d-flex align-items-center justify-content-center"
      style="width:100%; height:100%;padding:0; margin:0">
      <img src="{% static 'img/spd/logos/logo_junta_extremadura.png' %}" alt="">
    </div>
    <div class="col-3 d-flex align-items-center justify-content-center"
      style="width:100%; height:100%;padding:0; margin:0">
      <img src="{% static 'img/spd/logos/logo_interreg.png' %}" alt="">
    </div>
    <div class="col-3 d-flex align-items-center justify-content-center"
      style="width:100%; height:100%;padding:0; margin:0">
      <img src="{% static 'img/spd/logos/logo_rat_va_pc.png' %}" alt="">
    </div>
  </div>
  <div>
    <p style="line-height : 15px; font-size: 12px; font-family:'Roboto', sans-serif; text-align: center; color: white;">
      © Copyright 2021
      <span class="text-alerta2" style="font-size: 18px;">alerta<span style="font-size: 21px;">2</span></span>
    </p>
  </div>
</div>
<!-- End Logos -->



<!-- Menu Lateral Sidebar -->
<div id="sidebar" class="leaflet-sidebar collapsed">
  <!-- Nav tabs -->
  <div class="leaflet-sidebar-tabs">
    <ul role="tablist">
      <li>
        <a href="#aviso_provisionalidad" role="tab" style=" color: yellow;"><i class="fa-solid fa-info fa-beat"
            style="--fa-beat-scale: 2.0;"></i><span class="tooltip-sidebar">AVISO DE
            PROVISIONALIDAD</span></a>
      </li>
      <li>
        <a href="#capas" role="tab"><i class="fas fa-layer-group"></i><span class="tooltip-sidebar">CONTROL DE
            CAPAS</span></a>
      </li>
      <li>
        <a href="#estaciones" role="tab"><i class="fas fa-broadcast-tower"></i><span class="tooltip-sidebar">INFORMACIÓN
            DE UNA ESTACIÓN</span></a>
      </li>
    </ul>
  </div>

  <!-- Tab panes -->
  <div class="leaflet-sidebar-content" id="sidebar-contenido">
    <div class="loader-info-estacion">
      <span class="loader">
        <button class="btn btn-primary" type="button" disabled>
          <i class="fas fa-spinner fa-spin"></i>
          Cargando datos...
        </button>
      </span>
    </div>
    <div class="leaflet-sidebar-pane" id="aviso_provisionalidad">
      <div>
        <h2 style="padding-top: 20px; font-family: 'Bradley Hand ITC'; font-weight: bold;">Aviso sobre la
          provisionalidad de los
          datos en tiempo real</h2>
        <div class="linea-divisoria"></div>
        <p style="text-align: left; line-height: 20px;">
          <span class="text-spida">SPIDA </span>
          es un Sistema de Alerta Temprana con telecontrol en tiempo real a través de la cual se monitorean amenazas o
          eventos adversos de carácter previsible que puedan desembocar en episodios de inundación.
          <br><br>
          Los datos recopilados por los sensores de los diversos puntos de control existentes, son transmitidos
          de forma automática sin ningún tipo de aprobación final al Centro Hispano-Luso de Redes de Alerta Temprana
          <span class="text-alerta2" style="font-size: 22px;">alerta<span
              style="font-size: 25px; top: 0px;">2</span></span>
          , con una periodicidad decimominutal mediante comunicaciones LTE y/o IPSAT.
          <br><br>
          La alta frecuencia de transmision de los datos, aporta a éstos un caracter de provisionalidad hasta su
          posterior revisión, validacion y consolidacion por parte del personal técnico del Centro
          <span class="text-alerta2" style="font-size: 22px;">alerta<span
              style="font-size: 25px; top: 0px;">2</span></span>.
          <br><br>
          Consecuencia de ello, los datos no pueden ser legalmente utilizados ya que pueden estar afectados por
          diversos factores como:
        </p>
        <ul class="list-causas" style="text-align: left; line-height: 20px;">
          <li> Embalsamiento natural del agua debido a troncos y follaje.</li>
          <li> Crecimiento de la Vegetación próxima a los sensores. </li>
          <li> Funcionamiento incorrecto de los equipos de medición, registro y comunicación. </li>
          <li> Desembalses decontrolados. </li>
          <li> Transporte de sedimentos puntuales. </li>
        </ul>
        <p style="text-align: left; line-height: 20px;">
          <br>
          En cuanto a los datos meteorológicos (pluviometría), destacar que en ningún caso tendrán validez
          oficial los recopilados por las diversas estaciones que conforman
          <span class="text-spida"> SPIDA</span>
          , siendo los únicos datos meteorológicos válidos los proporcionados por la Agencia Estatal de Meteorología
          (Aemet), referente
          a la previsión de precipitación.
          <br><br>
          Motivos por los cuales se les advierte a los usuarios sobre la naturaleza provisional de la información
          contenida,
          antes de usarla para la toma de decisiones que conciernen a la seguridad personal o pública o aplicada a un
          negocio que suponga
          consecuencias económicas u operacionales substanciales.
          <br><br>
          Cualquier comentario debe realizarse al buzón de
          <span class="text-alerta2" style="font-size: 22px;">alerta<span
              style="font-size: 25px; top: 0px;">2</span></span>:
          <a style="color:'blue';" href="mailto:redalertaspida@gmail.com">redalertaspida@gmail.com</a>
        </p>
      </div>
    </div>

    <div class="leaflet-sidebar-pane" id="capas">
      <div id="loader-control-layers">
        <!-- Aqui voy a añadir el control de capas -->
      </div>
    </div>

    <div class="leaflet-sidebar-pane" id="estaciones">
      <h1 class="leaflet-sidebar-header">
        Información de la Estación<span class="leaflet-sidebar-close"><i class="fa fa-caret-right"></i></span>
      </h1>
      <select name="">
        {% for estacion in listaEstaciones %}
        <option value="{{estacion.Id}}">{{estacion.Red}}{{estacion.Tipo}} - {{estacion.Nombre}}</option>
        {% endfor %}
      </select>
      <div id="info-estacion">
      </div>
    </div>

  </div>
</div>
<!-- END Menu Lateral Sidebar -->




<script>

  /******************************************************************
    DECLARO LAS VARIABLES GLOBALES 
  *******************************************************************/

  var icon_aviso = "{% static 'img/spd/iconos/aviso.png' %}";
  var estaciones = null;
  var embalses = null;
  var avisos_met_aemet = null;
  let url_cargar_estaciones = "{% url 'spd:getEstaciones' %}";
  let url_cargar_embalses = "{% url 'spd:getEmbalses' %}";
  let url_cargar_cieloAemet = "{% url 'spd:getEstadoCieloAemet'%}";
  let url_cargar_temperaturaAemet = "{% url 'spd:getTemperaturaAemet'%}";
  let url_cargar_radarAemet = "{% url 'spd:getImagenesRadar'%}"
  let menuChart = ['viewFullscreen', 'downloadJPEG'];
  let layer_alarmas_animadas_level = 1

  if ('{{request.user.is_authenticated}}' == 'True') {
    menuChart = ["viewFullscreen", "separator", "downloadPNG", "downloadJPEG", "downloadPDF", "separator", "downloadXLS", "downloadCSV", "viewData"];/*"printChart",   "downloadSVG"*/
    layer_alarmas_animadas_level = 0
  }
</script>


<script>

  /******************************************************************
    DEFINO EL MAPA LEAFLET
  *******************************************************************/
  var map = L.map('map', {
    attributionControl: false,
    zoomControl: false,
    minZoom: 5,
    maxZoom: 18,
    timeDimension: true,
    timeDimensionOptions: {
      period: "PT1H",
    },
    contextmenu: true,
    contextmenuWidth: 200,
    contextmenuItems: [ //Menu click derecho sobre el mapa
      {
        text: 'Aumentar zoom',
        icon: '../../../static/img/spd/iconos/zoom_in.png',
        callback: zoomIn
      }, {
        text: 'Disminuir zoom',
        icon: '../../../static/img/spd/iconos/zoom_out.png',
        callback: zoomOut
      }]
  });

  /******************************************************************
    Funciones opciones menu click derecho sobre el mapa
  *******************************************************************/

  //Zoom in
  function zoomIn(e) {
    map.zoomIn();
  }

  //Zoom out
  function zoomOut(e) {
    map.zoomOut();
  }


  /*******************************************************************
    MAP SPINNER LOADING... (http://spin.js.org/)
  *******************************************************************/
  var spinner_options_map = {
    color: '#ffffff',
    fadeColor: 'transparent',
    zIndex: 1999,
    top: '50%',
    left: '50%',
    position: 'absolute',
    animation: 'spinner-line-fade-more',
  }

  var spinner_options_sidebar = {
    position: 'absolute',
    zIndex: 2001,
    color: '#009CDD',
    top: '50%',
    left: '50%',
    animation: 'spinner-line-fade-more',
  }

  /******************************************************************
    WATERMARK (Marca de agua en el mapa)
  ******************************************************************/
  L.Control.Watermark = L.Control.extend({
    onAdd: function (map) {
      var el = L.DomUtil.create('div', 'leaflet-bar my-control');
      var img = L.DomUtil.create('img');
      img.src = "{% static 'img/spd/logos/logo_alerta2_transparente.png' %}";
      el.innerHTML = '<img class="watermark" src="{% static "img/spd/logos/logo_alerta2_transparente.png" %}">'
        + '<p id="avisos"></p>'
      return el;
    },
    onRemove: function (map) {
      // Nothing to do here
    }
  });

  L.control.watermark = function (opts) {
    return new L.Control.Watermark(opts);
  }

  L.control.watermark().addTo(map);

  /******************************************************************
    PANEL SIDEBAR (PANEL MENU LATERAL)
  ******************************************************************/
  var sidebar = L.control.sidebar({ container: "sidebar", position: "right" }).addTo(map);

  // Si no hay un usuario loguado muestro el avisos de provisionalidad de datos 
  if ('{{request.user.is_authenticated}}' == 'False') {
    sidebar.open('aviso_provisionalidad')
  }
</script>


<!--*****************************************************************
  CARGO LAS CAPAS DE MARCADORES (Estaciones Saih, Spida, Embalses, Cielo Aemet, etc...)
******************************************************************-->
<script type="text/javascript" src="{% static 'js/spd/map_marcadores_spd.js' %}"></script>
<script src="{% static 'js/spd/reqwest.min.js' %}"></script>
<script src="{% static 'js/spd/leaflet-photo.js' %}"></script>
<script type="text/javascript" src="{% static 'js/spd/map_cargar_capas_spd.js' %}"></script>

<!-- Control Navbar (Boton Home y avanzar o retroceder movimientos historicos) -->
<!--https://github.com/davidchouse/Leaflet.NavBar-->
<script type="text/javascript" src="{% static 'js/spd/leaflet-navbar.js' %}"></script>


<script type="text/javascript">

  //DEFINO LA CAPA DE IMAGENES SPIDA
  var layer_imagenes_spida = L.photo.cluster().on('click', function (evt) {//dblclick
    createcustomIconLayerImagenesSpida(evt.layer);
  });

  /*Cuando pulso un marker de la miniatura de una imagen Spida, completo un Popup
  con el nombre de la estacion, la imagen en tamaño original y la fecha/hora de la
  imagen mostrada*/
  function createcustomIconLayerImagenesSpida(layerphotos) {
    /*map.spin(true);//activo el spin de cargando mapa*/

    var photo = layerphotos.photo;
    $.getJSON("{% url 'spd:getImagenSpida'%}?id=" + photo.id + '&c=' + photo.camara,
      function (data) {

        template = '<h5 id="titleBindPopUp">' + photo.nombre + '</h5>'
          + '<img data-enlargable style="min-width:300px; border-radius: 5px; width:100%; cursor: zoom-in" src="data:image/jpg;base64,' + data.imagen + '" alt="' + data.FechaHora + '">'
          //+ '<img style="min-width:300px; border-radius: 5px" src="data:image/jpg;base64,' + data.imagen + '" alt="' + data.FechaHora + '" style="width:100%" onclick="AbrirImagenModal(this.src,this.alt)">'
          + '<p id="contentBindPopUp">' + data.FechaHora + '</p>';

        layerphotos.bindPopup(L.Util.template(template, photo), {
          className: 'leaflet-popup-photo',
          maxWidth: 500
        }).openPopup();

        //Abrir imagen a pantalla completa 
        $('img[data-enlargable]').addClass('img-enlargable').click(function () {
          var src = $(this).attr('src');
          $('<div>').css({
            background: 'RGBA(0,0,0,.5) url(' + src + ') no-repeat center',
            backgroundSize: 'contain',
            width: '100%', height: '100%',
            position: 'fixed',
            zIndex: '10000000000000000',
            top: '0', left: '0',
            cursor: 'zoom-out'
          }).click(function () {
            $(this).remove();
          }).appendTo('#map');
        });
      })
      .fail(function () {
        console.log('getJSON Imagenes Spida request failed! ');
      })
    /*.always(function () {
      //map.spin(false);
    });*/
  };

  function CargarMiniaturaImagenesSpida() {
    $.ajax({
      type: "GET",
      dataType: "json",
      url: "{% url 'spd:getMiniaturasSpida'%}",
      success: function (data) {
        jsonImagenes = JSON.parse(data);
        var photos = [];
        for (var i = 0; i < jsonImagenes.length; i++) {
          if (jsonImagenes[i].id < 8000) {
            photos.push({
              lat: jsonImagenes[i].lat,
              lng: jsonImagenes[i].lng,
              url: jsonImagenes[i].imagen,
              nombre: jsonImagenes[i].nombre,
              caption: 'Ultima foto capturada el ' + jsonImagenes[i].fecha_hora + ' en ' + jsonImagenes[i].nombre,
              thumbnail: jsonImagenes[i].imagen,
              id: jsonImagenes[i].id,
              camara: jsonImagenes[i].camara
            });
          }
        }

        layer_imagenes_spida.clear();
        layer_imagenes_spida.add(photos);

        return jsonImagenes;
      }
    });
  };


  function ImagenesPrecipitacionAcumulada1hAemet(hora) {
    /*map.spin(true);*/
    var date_from = null;
    var msactual = new Date(new Date().getTime());

    $.getJSON("{% url 'spd:getImagenesPreAcumAemet'%}?h=" + hora,
      function (data) {
        datos_harmonie = data[0]; //obtengo solo el array de datos

        datos_harmonie = datos_harmonie.sort(function (a, b) { //ordeno el array con la primera columna (fecha/hora)
          return new Date(a[0]) - new Date(b[0]);
        });

        date_from = datos_harmonie[0][0];
        date_from = date_from.substring(0, date_from.length - 6) + "Z"; /* fecha comienzo */
        date_to = datos_harmonie[datos_harmonie.length - 1][0];
        date_to = date_to.substring(0, date_to.length - 6) + "Z"; /* fecha fin */

        horaIni = (new Date(date_to)).getHours();
        switch (Math.floor(horaIni / 6)) {
          case 0:
            cod_url = "00";
            break;
          case 1:
            cod_url = "06";
            break;
          case 2:
            cod_url = "12";
            break;
          case 3:
            cod_url = "18";
            break;
          default:
            cod_url = "00";
        };

        /*var ms = new Date().getTime();// + 86400000/24;
        var msactual = new Date(ms);*/
        map.timeDimension.setAvailableTimes(date_from + "/" + date_to + "/PT" + hora + "H", 'replace');
        map.timeDimension.setCurrentTime(new Date(date_from));

        //var ms = new Date().getTime() + 86400000/24*2;
        //var msactual = new Date(ms);
        //console.log("MS", msactual)
        //map.timeDimension.setCurrentTime(msactual); //establezco el valor actual de timeDimension (fecha_hora_actual)
      })
      .fail(function () {
        console.log('getJSON Imagenes Precipitacion Acumulada ' + hora + 'h Aemet request failed! ');
      })
      .always(function () {
        msactual = Date.now();
        times_availables = map.timeDimension.getAvailableTimes();
        if (times_availables.length > 0) {
          for (let i = 0; i < times_availables.length; i++) {
            //console.log(new Date(new Date(msactual).getTime()),new Date(new Date(times_availables[i]).getTime()));
            if (new Date(times_availables[i] - 86400000 / 24 * 2) > msactual) {
              //console.log(`MAYOR Numero: ${times_availables[i]} : ${i}`)
              if (i > 0) {
                map.timeDimension.setCurrentTime(new Date(times_availables[i - 1]));
              }
              break;
            }
          }
        }

        /*var horaseleccionada = new Date(date_from)
        console.log("SELECT: ", horaseleccionada)
        console.log("FROM: ", new Date(date_from))
        console.log("TO: ", new Date(date_to));
        while (msactual > new Date(date_from) && msactual < new Date(date_to)) {
          console.log("ENTRA")
          ///horaseleccionada = new Date(new Date(horaseleccionada).setHours(horaseleccionada.getHours() + hora));
          console.log("HORA SELECCIONADA: ", horaseleccionada)
        }
        console.log("HORA FIN", horaseleccionada)
        map.timeDimension.setCurrentTime(horaseleccionada);*/
      });
  };


</script>


<script type="text/javascript">

  function create_custom_dropdowns() {
    $('select').each(function (i, select) {
      if (!$(this).next().hasClass('dropdown-select')) {
        $(this).after('<div class="dropdown-select wide ' + ($(this).attr('class') || '') + '" tabindex="0"><span class="current">Seleccione una estación...</span><div class="list"><ul></ul></div></div>');
        var dropdown = $(this).next();
        var options = $(select).find('option');
        /*var selected = $(this).find('option:selected');
        dropdown.find('.current').html(selected.data('display-text') || selected.text());*/
        options.each(function (j, o) {
          var display = $(o).data('display-text') || '';
          /*dropdown.find('ul').append('<li class="option ' + ($(o).is(':selected') ? 'selected' : '') + '" data-value="' + $(o).val() + '" data-display-text="' + display + '">' + $(o).text() + '</li>');*/
          //dropdown.find('ul').append('<li class="option" data-value="' + $(o).val() + '" data-display-text="' + display + '">' + $(o).text() + '</li>');
          dropdown.find('ul').append('<li class="option" data-value="' + $(o).val() + '" data-display-text="' + display + '"><span style ="font-size:11px;">' + ($(o).text()).split('-')[0] + '</span>' + ' - ' + ($(o).text()).split('-')[1] + '</li>');
        });
      }
    });

    $('.dropdown-select ul').before('<div class="dd-search"><input id="txtSearchValue" autocomplete="off" onkeyup="filter()" class="dd-searchbox" type="text" placeholder="Buscar..."></div>');
  }

  // Event listeners

  // Open/close
  $(document).on('click', '.dropdown-select', function (event) {
    if ($(event.target).hasClass('dd-searchbox')) {
      return;
    }
    $('.dropdown-select').not($(this)).removeClass('open');
    $(this).toggleClass('open');
    if ($(this).hasClass('open')) {
      $(this).find('.option').attr('tabindex', 0);
      $(this).find('.selected').focus();
    } else {
      $(this).find('.option').removeAttr('tabindex');
      $(this).focus();
    }
  });

  // Close when clicking outside
  $(document).on('click', function (event) {
    if ($(event.target).closest('.dropdown-select').length === 0) {
      $('.dropdown-select').removeClass('open');
      $('.dropdown-select .option').removeAttr('tabindex');
    }
    event.stopPropagation();
  });

  function filter() {
    /*var valThis = $('#txtSearchValue').val();*/
    var valThis = ($('#txtSearchValue').val()).normalize('NFD').replace(/[\u0300-\u036f]/g, "").toUpperCase();
    $('.dropdown-select ul > li').each(function () {
      var text = $(this).text();
      /*(text.toLowerCase().indexOf(valThis.toLowerCase()) > -1) ? $(this).show() : $(this).hide(); */
      (text.normalize('NFD').replace(/[\u0300-\u036f]/g, "").toUpperCase().indexOf(valThis) > -1) ? $(this).show() : $(this).hide();
    });
  };
  // Search

  // Option click
  $(document).on('click', '.dropdown-select .option', function (event) {
    /*$(this).closest('.list').find('.selected').removeClass('selected');
    $(this).addClass('selected');
    var text = $(this).data('display-text') || $(this).text();
    $(this).closest('.dropdown-select').find('.current').text(text);
    $(this).closest('.dropdown-select').prev('select').val($(this).data('value')).trigger('change');*/
    $(".loader-info-estacion").fadeIn('fast');
    $('#info-estacion').html('')
    InfoEstacion($(this));
  });

  function InfoEstacion(estacion) {

    /*Para cargar el geojson de la subcuenca en el mapa*/
    $.getJSON("{% static 'js/spd/shapefiles/subcuencas/subcuenca' %}" + estacion.data('value') + ".geojson", function (data) {
      layer_subcuenca.clearLayers();
      layer_subcuenca.addData(data);
      map.fitBounds(layer_subcuenca.getBounds());
      /*map.flyToBounds(layer_subcuenca.getBounds(), {
        "animate": true,
        "duration": 6
      });*/

    }).always(function () {

      //Completo el contenido sidebar de la estacion
      HTMLInfoEstacion(estacion);
    });;

  };

  function HTMLInfoEstacion(estacion) {
    $.ajax({
      type: "GET",
      dataType: "json",
      url: "{% url 'spd:getInfoEstacion' %}?i=" + estacion.data('value'),
      success: function (data) {

        // Si se encuentra informacion de la estacion...
        if (data.info.length > 0) {
          estacion.closest('.list').find('.selected').removeClass('selected');
          estacion.addClass('selected');
          var text = estacion.data('display-text') || estacion.text();
          estacion.closest('.dropdown-select').find('.current').text(text);
          estacion.closest('.dropdown-select').prev('select').val(estacion.data('value')).trigger('change');

          // Si se trata de un embalse...
          if (data.info[0].T != undefined && data.info[0].T == 2) {

            console.log("Info Embalse", data)

            // Genero el HTML del interior del Sidebar para una estación del tipo EMBALSE
            var html = '';
            html += '<h2 class="cursive-brush title-estacion">' + data.info[0].Nombre + '</h2>'
              + '<div class="linea-divisoria"></div>'
            html += '<div class="col-12 m-b-10 sidebar-location">'
              + '<p style="text-align:left"><span style="font-weight: bold">Localización: </span><span style="font-weight: normal">' + data.info[0].Latitud + ' ' + data.info[0].Longitud
              + '. </span><a href="https://www.google.com/maps/place/' + data.info[0].Latitud + ',' + data.info[0].Longitud + '" target="_blank">Ir al sitio <i class="fas fa-location-arrow"></i></a></p>'
              + '</div>'
              //+ '<p style="text-align:left"><span style="font-weight: bold">Localización: </span><span style="font-weight: normal">' + data.info[0].Latitud + ' ' + data.info[0].Longitud
              //+ '. </span><a href="https://www.google.com/maps/place/' + data.info[0].Latitud + ',' + data.info[0].Longitud + '" target="_blank">Ir al sitio <i class="fas fa-location-arrow"></i></a></p>'
              + '<p style="text-align:left"><span style="font-weight: bold">Volumen embalse: </span><span style="font-weight: normal">' + data.data[0].V + ' % el ' + data.data[0].DTL + '</span></p>'
              + '<div class="slideshow-container"></div>'
              + '<figure class="highcharts-figure-Embalse">'
              + '<div id="graficoEmbalse" class="grafico-highcharts"></div>'
              + '</figure>'

            document.getElementById('info-estacion').innerHTML = html;
            LoadUltimaImagen(data.info[0].Id, data.info[0].T, data.info[0].R);
            CargarGraficoEmbalse('graficoEmbalse', data.info[0].Id, data.info[0].Nombre);


          }
          // Si se trata de cualquier otra estacion...
          else {

            // Genero el HTML del interior del Sidebar para una estación del tipo EMBALSE
            var html = ''
            html += '<h2 class="cursive-brush title-estacion">' + data.info[0].Nombre + '</h2>'
              + '<div class="linea-divisoria"></div>'
              + '<div class="col-12 m-b-10 sidebar-location">'
              + '<p style="text-align:left"><span style="font-weight: bold">Localización: </span><span style="font-weight: normal">' + data.info[0].Latitud + ' ' + data.info[0].Longitud
              + '. </span><a href="https://www.google.com/maps/place/' + data.info[0].Latitud + ',' + data.info[0].Longitud + '" target="_blank">Ir al sitio <i class="fas fa-location-arrow"></i></a></p>'
              + '</div>';
            //+ '<p style="text-align:left"><span style="font-weight: bold">Localización: </span><span style="font-weight: normal">' + data.info[0].Latitud + ' ' + data.info[0].Longitud
            //+ '. </span><a href="https://www.google.com/maps/place/' + data.info[0].Latitud + ',' + data.info[0].Longitud + '" target="_blank">Ir al sitio <i class="fas fa-location-arrow"></i></a></p>'

            // Si hay valores registrados...
            if (data.data.length > 0) {

              html += '<div class="col-12 m-b-20 m-t-20 p-r-0 p-l-0">'
                + '<div id="card-' + data.data[0].DTL + '" class="card ' + ColorCardEstadoEstacion(data.data[0].E) + ' text-white mb-3 mb-md-0" >'
                + '<div class="card-body d-flex justify-content-between align-items-end">'
                + '<div class="card-number">'
                + '<div class="h3 m-0" style="display: inline-block;">' + data.data[0].V
                + '<span style="font-size:15px"> metros </span>'
                + '</div><br><small><strong>' + data.data[0].DTL + '</strong></small>'
                + '</div>'
                + '<div class="card-info text-right"><small>' + IconoEstadoEstacion(data.data[0].E) + ' ' + DescripcionEstadoEstacion(data.data[0].E) + ' </small><br /><small><a href="#" onclick="MostrarPanelInfoAvisos();">+ Informacion <i class="fas fa-mouse-pointer"></i></a></small></div>'
                + '</div>'
                + '</div>'
                + '</div>'
                + '<div id="fluid-meter" style="text-align: center;"></div>';



              //html += '<p style="text-align:left"><span style="font-weight: bold">Nivel de Río: </span><span style="font-weight: normal">' + data.data[0].V + ' metros el ' + data.data[0].DTL + '</span></p>'
              //  + '<div id="fluid-meter" style="text-align: center;"></div>'

              // Si el estado de la estacion es correcto...
              //if (data.data[0].E != 10) {
              //  html += '<p style="text-align:left"><span style="font-weight: bold">Estado: </span>' + IconoEstadoEstacion(data.data[0].E)
              //    + '<span style="font-weight: normal"> ' + DescripcionEstadoEstacion(data.data[0].E) + '. </span><a href="#" onclick="MostrarPanelInfoAvisos();">+ Informacion <i class="fas fa-mouse-pointer"></i></a></p>'
              //}

              html += AddTiempoAemet(data.info[0].CodA)
                + '<div id="highcharts-figure-subcuenca"></div>'
                + '<div class="slideshow-container"></div>'
                + '<figure class="highcharts-figure-NivelRio">'
                + '<div id="graficoNivelRio" class="grafico-highcharts"></div>'
                //+ '<div class="highcharts-caption"><p><img src="../../../static/img/spd/iconos/aviso.png" style = "width:20px; height:20px"> Datos sujetos a validacion</p></div>'
                //+ '<p class="highcharts-description"><img src="../../../static/img/spd/iconos/aviso.png"> Datos sujetos a validacion</p>'
                + '</figure>'
                + '<figure class="highcharts-figure">'
                + '<div id="graficoPrecipitacion" class="grafico-highcharts"></div>'
                + '</figure>'
                + '<figure class="highcharts-figure">'
                + '<div id="graficoPrecipitacionCuenca" class="grafico-highcharts"></div>'
                + '</figure>';

              document.getElementById('info-estacion').innerHTML = html;
              if (data.data.length > 0 & data.data[0].C == 100) {
                LoadFluidMeter(Math.floor(data.data[0].V * 100 / data.info[0].N3));
              }
              LoadUltimaImagen(data.info[0].Id, data.info[0].T, data.info[0].R);
              CargarGraficoNivelRio('graficoNivelRio', data.info[0].Id, data.info[0].Nombre, data.info[0].N1, data.info[0].N2, data.info[0].N3);
              CargarGraficoPrecipitacion('graficoPrecipitacion', data.info[0].Id, data.info[0].Nombre);
              CargarGraficoPrecipitacionCuenca('graficoPrecipitacionCuenca', data.info[0].Id, data.info[0].Nombre);

              // Si se trata de una estación de la RED SPIDA y ademas el usuario está autenticado...
              if (data.info[0].R == 1 && "{{request.user.is_authenticated}}" == 'True') {
                CargarGraficoSubcuenca(data);
              }
            }
          }
        }
      },
      error: function () {
        console.log("getJSON Info Estacion request failed!");
      },
      complete: function () {
        $(".loader-info-estacion").fadeOut("slow");
        document.getElementById("sidebar-contenido").style.overflowY = 'auto';
        map.spin(false)
      }

    });
  }

  async function MostrarPanelInfoAvisos() {
    Swal.fire({
      html:
        "<h3 class='text-bradley' style='font-size:30px'><b>Tipos de aviso por riesgo de inundación</b></h3>" +
        "<div class='linea-divisoria'></div>" +
        "<br>" +
        '<p style="text-align:left; font-size:14px"><i class="fas fa-circle" style="color:#7B68EE;stroke: #1B1C1C;stroke-width: 20;padding-left:2px"></i>' +
        ' <b>SIN DATOS:</b> Caracterizado por la falta de datos de nivel de río y/o caudal.</p>' +
        '<p style="text-align:left; font-size:14px"><i class="fas fa-circle" style="color:#abff00;stroke: #1B1C1C;stroke-width: 20;padding-left:2px"></i>' +
        ' <b>NIVEL 0 o SIN AVISOS:</b> Caracterizado por niveles de caudal muy bajos o casi inexistentes con ninguna significancia.</p>' +
        '<p style="text-align:left; font-size:14px"><i class="fas fa-circle" style="color:#ff0;stroke: #1B1C1C;stroke-width: 20;padding-left:2px"></i>' +
        ' <b>NIVEL 1:</b> Caracterizado por la existencia de información sobre un aumento del nivel de caudal a priori sin importancia.</p>' +
        '<p style="text-align:left; font-size:14px"><i class="fas fa-circle" style="color:#FFA500;stroke: #1B1C1C;stroke-width: 20;padding-left:2px"></i>' +
        ' <b>NIVEL 2:</b> Caracterizado por la posibilidad de ocurrencia de sucesos y/o situaciones capaces de dar lugar a un estado ' +
        'de riesgo de inundación en funcion de la evolución de los fenómenos causantes del aumento de nivel de caudal.</p>' +
        '<p style="text-align:left; font-size:14px"><i class="fas fa-circle" style="color:#FF0000;stroke: #1B1C1C;stroke-width: 20;padding-left:2px"></i>' +
        ' <b>NIVEL 3:</b> Caracterizado por la posibilidad de ocurrencia de sucesos y/o situaciones capaces de ' +
        'dar lugar a un estado de peligro, por inundación inminente o bien porque ésta ya ha comenzado.</p>',
      //fas fa-exclamation-triangle: #000000,#90EE90,#90EE90,#FFFF00,#FFA500,#FFA500,#CD5C5C
      showConfirmButton: false,
      timer: 100000,
      timerProgressBar: true,
      focusConfirm: false,
      showCloseButton: true,
      didOpen: (toast) => {
        toast.addEventListener('mouseenter', Swal.stopTimer)
        toast.addEventListener('mouseleave', Swal.resumeTimer)
      }
    })
  }


  function LoadUltimaImagen(idEstacion, idTipo, idRed) {
    $.ajax({
      type: "GET",
      dataType: "json",
      //async: false,
      url: "{% url 'spd:getUltimaImagen' %}?i=" + idEstacion + "&t=" + idTipo,
      success: function (data) {
        var carrousel = '';

        // Si se han encontrado imagenes...
        if (data.length > 0) {
          carrousel += '<p style="text-align:left"><span style="font-weight: bold">Ultima imagen capturada: </span><span style="font-weight: normal">' + data[0].fecha_hora_local + '</span><p>'

          // Recorro todas las imagenes encontradas
          for (i = 0; i < data.length; i++) {
            carrousel += '<div class="mySlides">'
              + '<img data-enlargable src="data:image/jpg;base64,' + data[i].imagen + '" style="width:100%">'

            if ("{{request.user.is_authenticated}}" == "True") {
              if (idRed == 1) {
                carrousel += '<button class="btn img-capture" title="Captura" onclick="OpenCaptura(' + idEstacion + ', ' + data[i].id_camara + ')"><i class="fa-solid fa-image"></i></button>'

                console.log("PERMISO", "{{perms.auth.cam_spida_streaming}}")
                if ("{{perms.auth.cam_spida_streaming}}" == "True") {
                  carrousel += '<button class="btn img-streaming" title="Streaming" onclick="OpenStreaming(' + idEstacion + ', ' + data[i].id_camara + ')"><i class="fa-solid fa-clapperboard-play"></i></button>'
                }

              }
              else {
                carrousel += '<button class="btn img-capture" title="Streaming" onclick="OpenStreaming(' + idEstacion + ', ' + data[i].id_camara + ')"><i class="fa-solid fa-clapperboard-play"></i></button>'
              }
            }


            if (data.length > 1) {
              carrousel += '<div class="numbertext">' + (i + 1) + '/' + data.length + '</div>'
            }

            carrousel += '</div>'
          }
        }
        // Si no se han encontrado imagenes pero se trata de una estación SPIDA...
        else if (idRed == 1) {
          carrousel += '<p style="text-align:left"><span style="font-weight: bold">Ultima imagen capturada: </span><span style="font-weight: normal">Imagen no disponible</span><p>'
            + '<div class="mySlides">'
            + '<img src="{% static "img/spd/fondos/imagen_no_disponible1.jpg" %}" style="width:100%; cursor: auto">'
            + '</div>'
        }

        if (data.length > 1) {
          carrousel += '<a class="prev" onclick="plusSlides(-1)">&#10094;</a>'
            + '<a class="next" onclick="plusSlides(1)">&#10095;</a>'
        }

        // Añado imagenes al carrousel
        $(".slideshow-container").append(carrousel);

        if (carrousel != '') {
          showSlides(slideIndex);

          //Abrir imagen a pantalla completa 
          $('img[data-enlargable]').addClass('img-enlargable').click(function () {
            var src = $(this).attr('src');
            $('<div>').css({
              background: 'RGBA(0,0,0,.5) url(' + src + ') no-repeat center',
              backgroundSize: 'contain',
              width: '100%', height: '100%',
              position: 'fixed',
              zIndex: '10000000000000000',
              top: '0', left: '0',
              cursor: 'zoom-out'
            }).click(function () {
              $(this).remove();
            }).appendTo('#map');
          });
        }

      },
      error: function () {
        console.log("getJSON Ultima Imagen request failed!");
      }
    })
  };

  function OpenCaptura(idEstacion, idCamara) {
    var win = window.open();
    $.ajax({
      url: "{% url 'spd:getCapturaImagen'%}?i=" + idEstacion + '&c=' + idCamara,
      type: "GET",
      success: function (data) {
        if (data.length > 0) {
          setTimeout(() => {
            win.location = data;
          })
        }
        else {
          win.close();
          const Toast = Swal.mixin({
            toast: true,
            position: 'bottom-right',
            iconColor: 'white',
            customClass: {
              popup: 'colored-toast'
            },
            showConfirmButton: false,
            timer: 5000,
            timerProgressBar: true
          })
          Toast.fire({
            icon: 'error',
            title: 'No se puede acceder a la cámara en tiempo real'
          })
        }

      }
    });
  }

  function OpenStreaming(idEstacion, idCamara) {
    var win = window.open();
    $.ajax({
      url: "{% url 'spd:getStreamingImagen'%}?i=" + idEstacion + '&c=' + idCamara,
      type: "GET",
      success: function (data) {
        if (data.length > 0) {
          setTimeout(() => {
            win.location = data;
          })
          setTimeout(() => {
            console.log("CERRAR");
            win.close()
          }, 30000)
        }
        else {
          win.close();
          const Toast = Swal.mixin({
            toast: true,
            position: 'bottom-right',
            iconColor: 'white',
            customClass: {
              popup: 'colored-toast'
            },
            showConfirmButton: false,
            timer: 5000,
            timerProgressBar: true
          })
          Toast.fire({
            icon: 'error',
            title: 'No se puede acceder a la cámara en tiempo real'
          })
        }

      }
    });
  }


  async function LoadFluidMeter(porcentaje) {
    // Diseño el indicador animado del porcentaje de nivel de agua
    // https://www.cssscript.com/liquid-progress-indicator/
    var fm = new FluidMeter();
    fm.init({
      targetContainer: document.getElementById("fluid-meter"),
      fillPercentage: 0,
      options: {
        fontSize: "30px",
        fontFamily: "Roboto",
        drawPercentageSign: true,
        drawBubbles: true,
        size: 180,
        borderWidth: 10,
        backgroundColor: "#e2e2e2",
        foregroundColor: "#fafafa",
        foregroundFluidLayer: {
          fillStyle: "#16E1FF",
          angularSpeed: 30,
          maxAmplitude: 5,
          frequency: 30,
          horizontalSpeed: -20
        },
        backgroundFluidLayer: {
          fillStyle: "#4F8FC6",
          angularSpeed: 100,
          maxAmplitude: 3,
          frequency: 22,
          horizontalSpeed: 20
        }
      }
    });
    fm.setPercentage(porcentaje >= 0 ? porcentaje : 0);
  }

  async function AbrirImagenModal(imagen, descripcion) {
    // Get the modal
    var modal = document.getElementById("modalUltimaImagen");
    var modalImg = document.getElementById("UltimaImagen-modal");
    /*var captionText = document.getElementById("caption");*/
    modal.style.display = "block";
    modalImg.src = imagen;
    /*captionText.innerHTML = descripcion;*/
    // Get the <span> element that closes the modal
    var span = document.getElementsByClassName("closeUltimaImagen")[0];

    // When the user clicks on <span> (x), close the modal
    span.onclick = function () {
      modal.style.display = "none";
    }
  }

  /*Añado la prevision de Aemet durante los próximos días*/
  function AddTiempoAemet(widgetAemet) {
    //console.log("Hola", widgetAemet);
    if (widgetAemet != undefined) {
      var sizewindow = $(document).width();
      var anchura = Math.floor(sizewindow - 120);
      if (sizewindow >= 768)
        anchura = 500 - 60;
      return '<p style="text-align:left"><span style="font-weight: bold">Tendencia de la evolución meteorológica durante los próximos 3 días según Aemet:</span><p>' +
        '<div id="TiempoAemet" style="overflow: auto;text-align: center;padding-bottom: 15px;"><iframe id=\"iframe_aemet_id10024\" name=\"iframe_aemet_id10024\" src=\"http://www.aemet.es/es/eltiempo/prediccion/municipios/mostrarwidget/' + widgetAemet + '?w=g3p01110011ohmffffffw' + anchura + 'z251x4f86d9t95b6e9r1s8n2\" height=\"251\" frameborder=\"0\" scrolling=\"yes\" style="width:100%;"></iframe></div>';
      //'<div id="TiempoAemet" style="overflow: auto;text-align: center;padding-bottom: 15px;"><iframe id=\"iframe_aemet_id10024\" name=\"iframe_aemet_id10024\" src=\"http://www.aemet.es/es/eltiempo/prediccion/municipios/mostrarwidget/' + widgetAemet + '?w=g3p01110011ohmffffffw' + anchura + 'z251x4f86d9t95b6e9r1s8n2\" width=\"' + anchura + '\" height=\"251\" frameborder=\"0\" scrolling=\"yes\"></iframe></div>';
    }
    else {
      return '';
    }
  }

  // Keyboard events
  $(document).on('keydown', '.dropdown-select', function (event) {
    var focused_option = $($(this).find('.list .option:focus')[0] || $(this).find('.list .option.selected')[0]);
    // Space or Enter
    //if (event.keyCode == 32 || event.keyCode == 13) {
    if (event.keyCode == 13) {
      if ($(this).hasClass('open')) {
        focused_option.trigger('click');
      } else {
        $(this).trigger('click');
      }
      return false;
      // Down
    } else if (event.keyCode == 40) {
      if (!$(this).hasClass('open')) {
        $(this).trigger('click');
      } else {
        focused_option.next().focus();
      }
      return false;
      // Up
    } else if (event.keyCode == 38) {
      if (!$(this).hasClass('open')) {
        $(this).trigger('click');
      } else {
        var focused_option = $($(this).find('.list .option:focus')[0] || $(this).find('.list .option.selected')[0]);
        focused_option.prev().focus();
      }
      return false;
      // Esc
    } else if (event.keyCode == 27) {
      if ($(this).hasClass('open')) {
        $(this).trigger('click');
      }
      return false;
    }
  });

  $(document).ready(function () {
    create_custom_dropdowns();
    $(".loader-info-estacion").fadeOut("slow");
  });
</script>











<script type="text/javascript" src="{% static 'js/spd/map_graficos_highchart_spd.js' %}"></script>
<script type="text/javascript">

  function CargarGraficoSubcuenca(idEstacion, nombreEstacion) {
    GraficoSubcuenca(idEstacion, nombreEstacion);
  }

  function CargarGraficoEmbalse(Grafico, idEstacion, nombreEstacion) {

    var options = GraficoEmbalse(nombreEstacion);
    const chart = Highcharts.chart(Grafico, options);

    chart.showLoading();

    var num_axisy = 0

    $.ajax({
      url: "{% url 'spd:getDatosEmbalse'%}?estacion=" + idEstacion,
      type: "GET",
      dataType: "json",
      success: function (data) {

        if (data.precipitacion.length > 0) {
          data_precipitacion = data.precipitacion.map(Object.values)

          chart.addAxis({
            title: false,
            opposite: true,
            labels: {
              style: {
                color: '#87CEEB'
              }
            }
          }, false, false);
          num_axisy += 1
          chart.addSeries({
            name: "Precipitación 1h (mm)",
            data: data_precipitacion.map(function (point) {
              return [
                new Date(point[0]).getTime(),
                point[1]
              ];
            }),
            type: 'column',
            color: '#87CEEB',
            yAxis: num_axisy
          });

        }

        if (data.caudal.length > 0) {
          data_caudal = data.caudal.map(Object.values)
          chart.addAxis({
            title: false,
            opposite: true,
            labels: {
              style: {
                color: 'red'
              }
            }
          }, false, false); // don't redraw
          num_axisy += 1
          chart.addSeries({
            name: "Caudal aliviado (m3/s)",
            data: data_caudal.map(function (point) {
              return [
                new Date(point[0]).getTime(),
                point[1]
              ];
            }),
            type: 'line',
            color: 'red',
            yAxis: num_axisy
          });
        }

        data_volumen = data.volumen.map(Object.values)

        chart.series[0].setData(data_volumen.map(function (point) {
          return [
            new Date(point[0]).getTime(),
            point[1]
          ];
        }));

        chart.legend.update({
          enabled: true,
        });

        chart.update({
          chart: {
            //plotBackgroundImage: 'https://i.pinimg.com/originals/58/9b/f2/589bf2475b5c47aeb1d3533d93fbbdf7.gif'
            //plotBackgroundImage: "{% static 'img/spd/logos/logo_alerta2_transparente.png' %}"
            plotBackgroundImage: 'http://alerta2.es/static/img/spd/logos/logo_alerta2_transparente.png'
          }
        })

        chart.hideLoading();
      },
      cache: false,
      complete: function () {
        document.querySelectorAll('.highcharts-root > image')
          .forEach((function (x) { x.setAttribute("preserveAspectRatio", "meet"); }))
      }
    });

  }

  function CargarGraficoNivelRio(Grafico, idEstacion, nombreEstacion, N1, N2, N3) {

    var options = GraficoNivelRio(nombreEstacion, N1, N2, N3);
    const chart = Highcharts.chart(Grafico, options);


    /*$('#graficoNivelRio').bind('dblclick', function () {
      $(this).toggleClass('modal');
      //console.log("TITLE", (chart.options.title.text).includes(nombreEstacion));
      if ((chart.options.title.text).includes(nombreEstacion)) {
        chart.setTitle({ text: 'Nivel de Río' });
        chart.setSubtitle({ text: 'Valores registrados durante las últimas 24 horas' });
      }
      else {
        chart.setTitle({ text: nombreEstacion });
        chart.setSubtitle({ text: 'Valores de Nivel de Río registrados durante las últimas 24 horas' });
      }
      chart.reflow();
    });*/



    chart.showLoading();
    $.ajax({
      url: "{% url 'spd:getValoresPrediccion24h'%}?estacion=" + idEstacion + "&canal=100",
      type: "GET",
      dataType: "json",
      success: function (data) {

        var valormax_registrado = 0
        var valormax_prediccion = 0


        if (data.prediccion.length > 0) {
          //console.log("Hay prediccion")
          valores_prediccion = data.prediccion.map(Object.values)
          valormax_prediccion = Math.max.apply(Math, valores_prediccion.map(v => v[1]));
        }
        valores_registrados = data.valores.map(Object.values)
        valormax_registrado = Math.max.apply(Math, valores_registrados.map(v => v[1]));

        var valormax = Math.max(valormax_registrado, valormax_prediccion);
        var ymax = ((N3 > valormax) ? N3 : valormax);
        ymax = 1.15 * ymax;
        /*console.log("YMAX",ymax, N3, valormax);*/

        chart.yAxis[0].update({
          max: ymax
        })

        chart.series[0].setData(valores_registrados.map(function (point) {
          return [
            new Date(point[0]).getTime(),
            point[1]
          ];
        }));

        if (data.prediccion.length > 0) {
          chart.addSeries({
            name: "Nivel de Río predicho",
            data: valores_prediccion.map(function (point) {
              return [
                new Date(point[0]).getTime(),
                point[1]
              ];
            }),
            dashStyle: 'Dash',
            lineColor: '#1B1C1C',
          });
          /*chart.series[1].setData(valores_prediccion.map(function(point) {
                                return [
                                new Date(point[0]).getTime(),
                                point[1]
                                ];
                                }));*/
          chart.legend.update({
            enabled: true,
          });
        }

        chart.update({
          chart: {
            //plotBackgroundImage: 'https://i.pinimg.com/originals/58/9b/f2/589bf2475b5c47aeb1d3533d93fbbdf7.gif'
            //plotBackgroundImage: "{% static 'img/spd/logos/logo_alerta2_transparente.png' %}"
            plotBackgroundImage: 'http://alerta2.es/static/img/spd/logos/logo_alerta2_transparente.png'
          }
        })

        /*if(data.prediccion.length>0){
          
            
          chart.legend.update({
              enabled: true,
          });
        }*/
        chart.hideLoading();
      },
      cache: false,
      complete: function () {
        document.querySelectorAll('.highcharts-root > image')
          .forEach((function (x) { x.setAttribute("preserveAspectRatio", "meet"); }))
      }
    });
  }


  function CargarGraficoPrecipitacion(Grafico, idEstacion, nombreEstacion) {

    var options = GraficoPrecipitacion(nombreEstacion);
    var chart = Highcharts.chart(Grafico, options);

    /*$('#graficoPrecipitacion').bind('dblclick', function () {
      $(this).toggleClass('modal');
      if ((chart.options.title.text).includes(nombreEstacion)) {
        chart.setTitle({ text: 'Precipitación Acumulada en 1 hora' });
        chart.setSubtitle({ text: 'Valores registrados durante las últimas 24 horas' });
      }
      else {
        chart.setTitle({ text: nombreEstacion });
        chart.setSubtitle({ text: 'Valores de Precipitación Acumulada en 1 hora registrados durante las últimas 24 horas' });
      }
      chart.reflow();
    });*/

    chart.showLoading();

    $.ajax({
      url: "{% url 'spd:getValoresPrediccion24h'%}?estacion=" + idEstacion + "&canal=301",
      type: "GET",
      dataType: "json",
      success: function (data) {

        if (data.prediccion.length > 0) {
          valores_prediccion = data.prediccion.map(Object.values)
        }
        valores_registrados = data.valores.map(Object.values)


        chart.series[0].setData(valores_registrados.map(function (point) {
          return [
            new Date(point[0]).getTime(),
            point[1]
          ];
        }));

        if (data.prediccion.length > 0) {
          chart.addSeries({
            name: "Precipitación predicha",
            data: valores_prediccion.map(function (point) {
              return [
                new Date(point[0]).getTime(),
                point[1]
              ];
            }),
            type: 'column'
          });

          /*chart.series[1].setData(valores_prediccion.map(function(point) {
                                return [
                                new Date(point[0]).getTime(),
                                point[1]
                                ];
                                }));*/

          chart.legend.update({
            enabled: true,
          });
        }

        chart.update({
          chart: {
            //plotBackgroundImage: 'https://i.pinimg.com/originals/58/9b/f2/589bf2475b5c47aeb1d3533d93fbbdf7.gif'
            //plotBackgroundImage: "{% static 'img/spd/logos/logo_alerta2_transparente.png' %}"
            plotBackgroundImage: 'http://alerta2.es/static/img/spd/logos/logo_alerta2_transparente.png'
          }
        })
        //data=data.map( Object.values)
        /*data=data.map( Object.values)
        chart.series[0].setData(data.map(function(point) {
                                return [
                                new Date(point[0]).getTime(),
                                point[1]
                                ];
                                }));*/
        chart.hideLoading();
      },
      cache: false,
      complete: function () {
        document.querySelectorAll('.highcharts-root > image')
          .forEach((function (x) { x.setAttribute("preserveAspectRatio", "meet"); }))
      }

    });
  }


  function CargarGraficoPrecipitacionCuenca(Grafico, idEstacion, nombreEstacion) {

    var options = GraficoPrecipitacion(nombreEstacion);
    var chart = Highcharts.chart(Grafico, options);
    chart.setTitle({ text: 'Precipitación de la Cuenca Acumulada en 1 hora' });

    $('#graficoPrecipitacionCuenca').bind('dblclick', function () {
      $(this).toggleClass('modal');
      if ((chart.options.title.text).includes(nombreEstacion)) {
        chart.setTitle({ text: 'Precipitación de la Cuenca Acumulada en 1 hora' });
        chart.setSubtitle({ text: 'Valores registrados durante las últimas 24 horas' });
      }
      else {
        chart.setTitle({ text: nombreEstacion });
        chart.setSubtitle({ text: 'Valores de Precipitación de la Cuenca Acumulada en 1 hora registrados durante las últimas 24 horas' });
      }
      chart.reflow();
    });

    chart.showLoading();

    $.ajax({
      url: "{% url 'spd:getValoresPrediccion24h'%}?estacion=" + idEstacion + "&canal=302",
      type: "GET",
      dataType: "json",
      success: function (data) {

        if (data.prediccion.length > 0) {
          valores_prediccion = data.prediccion.map(Object.values)
        }
        valores_registrados = data.valores.map(Object.values)


        chart.series[0].setData(valores_registrados.map(function (point) {
          return [
            new Date(point[0]).getTime(),
            point[1]
          ];
        }));

        if (data.prediccion.length > 0) {
          chart.addSeries({
            name: "Precipitación predicha",
            data: valores_prediccion.map(function (point) {
              return [
                new Date(point[0]).getTime(),
                point[1]
              ];
            }),
            type: 'column'
          });
          /*chart.series[1].setData(valores_prediccion.map(function(point) {
                                return [
                                new Date(point[0]).getTime(),
                                point[1]
                                ];
                                }));*/

          chart.legend.update({
            enabled: true,
          });
        }

        chart.update({
          chart: {
            //plotBackgroundImage: 'https://i.pinimg.com/originals/58/9b/f2/589bf2475b5c47aeb1d3533d93fbbdf7.gif'
            //plotBackgroundImage: "{% static 'img/spd/logos/logo_alerta2_transparente.png' %}"
            plotBackgroundImage: 'http://alerta2.es/static/img/spd/logos/logo_alerta2_transparente.png'
          }
        })

        chart.hideLoading();
      },
      cache: false,
      complete: function () {
        document.querySelectorAll('.highcharts-root > image')
          .forEach((function (x) { x.setAttribute("preserveAspectRatio", "meet"); }))
      }
    });
  }

</script>




<script type="text/javascript">

  var legendPreMetedoNumericoAemet = L.control({ position: 'bottomleft' });

  legendPreMetedoNumericoAemet.onAdd = function (map) {
    var div = L.DomUtil.create('div', 'info legend');
    /*Funcion que obtiene los colores para la leyenda de la precipitacion acumulada 1 hora de aemet (Imagenes modelos numericos) */
    $.getJSON("{% url 'spd:getLegendaModelosNumericos' %}",
      function (data) {
        var objectsArray = [];
        /*Obtengo el numero de colores que tiene la leyenda*/
        var numColors = 0;
        for (let i in data) {
          for (let j in data[i]) {
            if (data[i][j].Valores != undefined) {
              numColors = data[i].length;
              objectsArray.push({ "RangoIni": data[i][j].Valores[0], "RangoFin": data[i][j].Valores[1], "Color": data[i][j].RGBA });
            }
          }
        }

        var ValuesLegend = objectsArray;
        div.innerHTML += '<p style="font-weight: bold; margin: 0px 0px 8px;">Precipitación en 1 hora (mm)</p>';
        for (var i = (ValuesLegend.length - 1); i >= 0; i--) {
          div.innerHTML +=
            '<span style="background:rgba(' + ValuesLegend[i].Color[0] + ',' + ValuesLegend[i].Color[1] + ',' + ValuesLegend[i].Color[2] + ',' + ValuesLegend[i].Color[3] + ');">' + ValuesLegend[i].RangoIni + '</span> ';
        }


      })
      .fail(function () {
        console.log('getJSON Legenda Modelos Numericos Aemet request failed! ');
      });
    return div;
  };

</script>


<!-- ===========================================================
      CONTROLES MAPA (Botones, zoom, control de capas, timelapse, etc...)
    ===========================================================-->
<script type="text/javascript" src="{% static 'js/spd/map_controles_spd.js' %}"></script>



<!-- ===========================================================
      SALVAPANTALLAS INTERACTIVO (Mapa animado cuando no se interactua con el)
    ===========================================================-->
<!-- SALVAPANTALLAS -->
<!--<script type="text/javascript" src="{% static 'js/spd/map_salvapantallas_spd.js' %}"></script>-->
<script type="text/javascript">
  $('.leaflet-control-zoom-in').text('');
  $('.leaflet-control-zoom-out').text(''); 
</script>







<!-- TEMPORIZADOR PARA REGARGAR LOS DATOS TRANSCURRIDOS 5 MINUTOS-->
<script>
  var tiempo_actualizar = 300; //segundos (5 minutos)
  var progreso = tiempo_actualizar;
  var idIterval = setInterval(function () {
    progreso += 1;
    if (progreso >= tiempo_actualizar) {
      progreso = 0;
      $('#bar').css('width', progreso + '%');

      ImagenesPrecipitacionAcumulada1hAemet(1);
      CargarEstaciones();
      CargarCieloAemet();//Cargo el estado del cielo de Aemet
      CargarTemperaturaAemet();
      CargarEmbalses();
      CargarMiniaturaImagenesSpida();
      CargarRadarAemet();
      //CargarZonasMetAemet();
      CargarInfoAvisosMetAemet();

      //Actualizo el sidebar de la estacion que esá seleccionada
      $sidebarInfoEstacion = $('.dropdown-select .option.selected')
      if ($sidebarInfoEstacion.length > 0) {
        $(".loader-info-estacion").fadeIn('fast');
        InfoEstacion($sidebarInfoEstacion);
      }

      //Vista inicial mapa
      map.fitBounds(layer_zonas_met_aemet.getBounds());//Ajusto el mapa al contorno de extremadura*/
    }
    else {
      var valorAncho = (progreso / tiempo_actualizar) * 100;
      $('#bar').css('width', valorAncho + '%');
    }

  }, 1000);
</script>

<script>
  map.addControl(layer_subcuenca)
  map.addControl(layer_alarmas_animadas);
  map.addControl(layer_estaciones_spida);
  map.addControl(layer_estaciones_saih_guadiana);
  map.addControl(layer_estaciones_saih_tajo);
  map.addControl(layer_estado_cielo_aemet);
  map.removeLayer(layer_embalses);

  if ('{{request.user.is_authenticated}}' == 'False') {
    myLayersControl.removeLayer(layer_estaciones_saih_tajo);
    myLayersControl.removeLayer(layer_estaciones_saih_guadiana);
    myLayersControl.removeLayer(layer_embalses);
  }
    /*else {
map.addControl(printMap);
}*/
</script>


<script>
  $('.emergency-alerts__cycle--prev').on('click', function () {
    var $prev = $('.emergency-alert.current').removeClass('current').prev('.emergency-alert');
    if ($prev.length) {
      $prev.addClass('current');
    } else {
      $(".emergency-alert:last").addClass('current');
    }
  });

  $('.emergency-alerts__cycle--next').on('click', function () {
    var $next = $('.emergency-alert.current').removeClass('current').next('.emergency-alert');
    if ($next.length) {
      $next.addClass('current');
    } else {
      $(".emergency-alert:first").addClass('current');
    }
  });

  /*$('.emergency-alerts__collapse').on('click', function () {
    $('.emergency-alerts__collapse > svg').toggleClass("fa-solid fa-chevron-down");
    // $('.emergency-alert__description').toggleClass("hidden");
    // $('.emergency-alert__link').toggleClass("hidden");
    // $('.emergency-alert__date').toggleClass("hidden");
    $('.emergency-alerts').toggleClass('collapsed');
  });*/

</script>




<script>
  let slideIndex = 1;
  // Next/previous controls
  function plusSlides(n) {
    showSlides(slideIndex += n);
  }

  // Thumbnail image controls
  function currentSlide(n) {
    showSlides(slideIndex = n);
  }

  function showSlides(n) {
    let i;
    let slides = document.getElementsByClassName("mySlides");
    //let dots = document.getElementsByClassName("dot");
    if (n > slides.length) { slideIndex = 1 }
    if (n < 1) { slideIndex = slides.length }
    for (i = 0; i < slides.length; i++) {
      slides[i].style.display = "none";
    }
    /*for (i = 0; i < dots.length; i++) {
      dots[i].className = dots[i].className.replace(" active", "");
    }*/
    slides[slideIndex - 1].style.display = "block";
    //dots[slideIndex-1].className += " active";
  }
</script>


<!--<script>
    window.intergramId = "530544321";
    window.intergramCustomizations = {
      closedChatAvatarUrl: "{% static 'img/spd/logos/logo_laruex.png' %}",
      introMessage: 'Hola! En que puedo ayudarle?',
      closedStyle: 'chat', // button or chat
    };
  </script>
  <script id="intergram" type="text/javascript" src="https://www.intergram.xyz/js/widget.js"></script>-->




{% endblock %}
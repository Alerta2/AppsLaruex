
{% extends "base/base_timetrackpro.html" %}
{% load static %}
{% block imports %}

    <!-- fullcalendar-->
  <!-- <script src='https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@6.1.9/index.global.min.js'></script> -->

  <link rel="stylesheet" href="{% static 'css/timetrackpro/fullcalendar/fullcalendar.css' %}" />
  <script src="{% static 'js/timetrackpro/fullcalendar/fullcalendar.js' %}"></script>
  <script src="{% static 'js/timetrackpro/fullcalendar/fullcalendar_es.js' %}"></script>
  <link rel="stylesheet" href="{% static 'css/timetrackpro/fullcalendar/calendario_mesual.css' %}" />
    <!-- disponible para configuración servidor-->

    <!-- <link rel="stylesheet" href="{% static 'css/timetrackpro/fullcalendar/fullcalendar.css' %}" /> -->

  {% endblock %}
{% block content %}
  <div class="row d-flex justify-content-center">
    <div class="col-12 col-xl-6 ">
        <div class="d-block shadow-xl border-radius-xl">
          <div class="row ">
            <div class="col m-3">

              <div id="calendarioMensual">
              </div>
            </div>

          </div>
      </div>
    </div>
    <div class="col-12 col-xl-6">
      {% if not userDjango%}
      <div class="pb-0 p-3 d-flex justify-content-end mb-4" style="background-color: transparent;">
        <div class="row">
          {% if vacaciones %}

          <div class="col">

           <button class="botonLinkFestivos" data-toggle="modal" data-target="#modalSolicitarModificacionVacaciones">             
            <div class="sign-Btn-link">
              <i class="fa-kit fa-solid-calendar-days-pen fa-lg ms-2" style="color: #ffffff;"></i></div>
            <div class="text text-sm">Solicitar cambio</div>
          </button>
          </div>
          {% endif %}
          <div class="col">
          <button class="botonLink" data-toggle="modal" data-target="#modalSolicitarVacaciones">    
            
            <div class="sign-Btn-link">
              <i class="fa-solid fa-plus fa-lg " style="color: #ffffff;"></i>
          </div>
            <div class="text text-sm">Solicitar Vacaciones</div>
          </button>
          </div>
        </div>
      </div>
    {% endif %}

      <div class="card">
        <div class="card-header pb-0 p-3">
          <div class="row">
            <div class="col-md-8 d-flex align-items-center">
              <div class="row">
                
                <h5 class="mb-2">
                  Vacaciones elegidas por {{usuario.id_usuario.nombre}} {{usuario.id_usuario.apellidos}}
                </h5>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card-body pt-0 p-3" >
          {% if not vacaciones %}
          <p class="text-sm"><strong class="text-info">Aún no ha seleccionado vacaciones</strong></p>
          {% else %}
          <div class="table-responsive ms-3 me-3">
            <table class="table align-items-center mb-0 ">
              <thead>
                <tr>
                                  <!-- <th class="text-uppercase text-secondary text-sm font-weight-bolder opacity-7 ps-2">Vacaciones</th> -->

                  <th class="text-secondary text-sm font-weight-bolder opacity-7 ps-2">Vacaciones</th>
                  <th class="text-secondary text-sm font-weight-bolder opacity-7 ps-2">Inicio</th>
                  <th class="text-secondary text-sm font-weight-bolder opacity-7 ps-2">Fin</th>
                  <th class="text-secondary text-sm font-weight-bolder opacity-7 ps-2 text-center">Días</th>
                  <th class="text-secondary text-sm font-weight-bolder opacity-7 ps-2 text-center">Estado</th>
                </tr>
              </thead>
              <tbody>
                {% for v in vacaciones %}   
                
                <tr>
                  <td>
  
                    <div>
                      <span class="text-md font-weight-bold ">{{v.tipo_vacaciones__nombre}} </span>
                    </div>
                  </td>
                  <td>
                        <div class="d-flex justify-content-start">
                          <span class="text-md font-weight-bold">{{v.fecha_inicio|date:"d M Y"}}</span>
                        </div>
                  </td>
                  <td>
                        <div class="d-flex justify-content-start">
                          <span class="text-md font-weight-bold">{{v.fecha_fin|date:"d M Y"}}</span>
                        </div>
                  </td>
                  <td class="text-center">
                    <span class="text-md font-weight-bold"> {{v.dias_consumidos|safe}}</span>
                  </td>
                  <td>
                    <div class="d-flex justify-content-center" data-toggle="tooltip" data-placement="top" title="{{v.estado__nombre}}">
                    {% if v.estado__id == 9 %}
                      <i class="fa-solid fa-circle-pause fa-lg me-3" style="color: #32325d;"></i>
                    {% elif v.estado__id == 10 %}
                    <i class="fa-solid fa-circle-xmark fa-lg me-3" style="color: #ea0606;"></i>
                    {% elif v.estado__id == 11 %}
                      <i class="fa-solid fa-circle-check fa-lg me-3" style="color: #82d616;"></i>
                    {% endif  %}
                  </div>
  
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% endif %}
          


      
        </div>
      </div>
    </div>
  </div>


  <div id="modalSolicitarVacaciones" tabindex="-1" role="dialog" class="modal fade modal-lg" aria-labelledby="modalSolicitarVacaciones"
  aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Solicitar periodo de vacaciones</h5>
          <button type="button" class="close close-modal" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <div class="modal-body">
        <form id="formularioAsociarHabilitacion" action="{% url 'timetrackpro:solicitar-vacaciones' %}" method="POST"
          enctype="multipart/form-data">
          {% csrf_token %}

          <div class="row">
            <div class="col-xl-12 mb-2">
              <label class="col-form-label">Seleccione un periodo vacacional</label>
              <div class="">
                <select class="form-control" aria-label="Nombre en el dispositivo" id="tipo_dias"
                name="tipo_dias" aria-describedby="text-addon" required>
                <option value="0" selected hidden>Seleccione el periodo de vacaciones</option>
                {% for periodo in periodosVacaciones %}
                <option value="{{periodo.id}}">{{periodo.nombre}}</option>
                {% endfor %}
                </select>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-xl-6">
              <label class="col-form-label">Fecha de inicio</label>
              <div class="">
                <input type="date" class="form-control" aria-label="Fecha inicial de las vacaciones"
                  aria-describedby="text-addon" name="fecha_inicio" id="fecha_inicio" onchange="calcularDias()">
              </div>
            </div>
            <div class="col-xl-6" >
              <label class="col-form-label">Fecha de fin</label>
              <div class="">
                <input type="date" class="form-control" aria-label="Fecha final de las vacaciones"
                  aria-describedby="text-addon" name="fecha_fin" id="fecha_fin" onchange="calcularDias()">
                <input type="number" class="form-control" name="dias_consumidos" id="dias_consumidos"  min="1" hidden >
                <input type="number" class="form-control" name="year" id="year" value="{% now 'Y' %}" hidden>
              </div>  
            </div>
          </div>
        </div>
        <div class="modal-footer">
          {% if user.is_authenticated  %}
          <button type="submit" value="submit"  class="btn btn-primary">Guardar</button>
          {% endif %}
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
        </div>
      </form>
      </div>
    </div>
  </div>

  <div id="modalSolicitarModificacionVacaciones" tabindex="-2" role="dialog" class="modal fade modal-lg" aria-labelledby="modalSolicitarModificacionVacaciones"
  aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Modificar vacaciones</h5>
          <button type="button" class="close close-modal" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <div class="modal-body">
        <form id="formularioAgregarHabilitacion" action="{% url 'timetrackpro:solicitar-modificar-vacaciones' %}" method="POST"
          enctype="multipart/form-data">
          {% csrf_token %}
          <div class="row  d-flex justify-content-center">
            <div class="col-xl-10">
              <label class="col-form-label">Seleccione las vacaciones</label>

              
              <div class="mb-3">
                <select class="form-control" aria-label="Nombre en el dispositivo" id="vacaciones_modificar"
                name="vacaciones_modificar" aria-describedby="text-addon" >
                {% for v in vacaciones %} 

                <option value="{{v.id}}">{{v.tipo_vacaciones__nombre}} {{v.id}}</option>
                
                {% endfor %}

              </select>
              
              </div>

            </div>
          </div>

          <div class="row d-flex justify-content-center">
            <div class="col-xl-5">
              <label class="col-form-label">Nueva fecha de inicio</label>

              <input type="date" class="form-control" name="fechaInicioActual" id="fechaInicioActual" >
            </div>
            <div class="col-xl-5">
              <label class="col-form-label">Nueva fecha de fin</label>

              <input type="date" class="form-control" name="fechaFinActual" id="fechaFinActual" >
            </div>
          </div>

        </div>
        <div class="modal-footer">
          {% if user.is_authenticated  %}
          <button type="submit" value="submit" class="btn btn-primary">Guardar</button>
          {% endif %}
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
        </div>
      </form>
      </div>
    </div>
  </div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    var calendarDiv = document.getElementById('calendarioMensual');
    var initialDate = '{{initialDate}}';
    var calendar = new FullCalendar.Calendar(calendarDiv, {
      initialDate: initialDate, // will be parsed as local
      themeSystem: 'bootstrap5',
      events: "{% url 'timetrackpro:datos-festivos-calendario' %}",
      //eventColor: '#20c997', // color de los eventos
      height: 650, // indico el maximo de alto que puede tener el calendario
      locale: 'es', // el idioma del calendario
      handleWindowResize: true, // si se puede redimensionar el calendario
      initialView: 'dayGridMonth', // la vista inicial del calendario
      buttonText: { // los textos de los botones
        today: 'Hoy',
        month: 'Mes',
        day: 'Día',
      }, 
      headerToolbar: { // la barra superior donde se encuentra el titulo y los botones
        left: 'prev,next',
        center: 'title',
        right:'today',
      },
      // Esta función se ejecutará cuando se haga clic en un día en el calendario         
      dateClick: function(info) {
        // se obtiene la fecha seleccionada
        const meses = {
            "01": "Enero",
            "02": "Febrero",
            "03": "Marzo",
            "04": "Abril",
            "05": "Mayo",
            "06": "Junio",
            "07": "Julio",
            "08": "Agosto",
            "09": "Septiembre",
            "10": "Octubre",
            "11": "Noviembre",
            "12": "Diciembre",
          };
        // se obtiene la fecha seleccionada
        var dia = info.dateStr.substring(8, 10);
        dia = dia.replace(/^0+/, '');
        var mes = meses[info.dateStr.substring(5, 7)];
        var year = info.dateStr.substring(0, 4);
        
        // se muestra el modal para agregar el festivo
        var label = document.getElementById("tituloModalAgregarDesdeCalendario");
        label.innerHTML = "Agregar festivo el día " + dia + " de " + mes + " del " + year;

        // se obtiene el año actual
        var yearActual = document.getElementById("year_actual");
        yearActual.value = year;

        var fechaInicio = document.getElementById("fecha_inicio_seleccionada");
        fechaInicio.value = info.dateStr;
        // modifico el index del calendario
       // se muestra el modal
        $('#modalAgregarFestivoDesdeCalendario').modal('show');
      
        },
    });
    calendar.render(); // renderizo el calendario
    calendar.updateSize(); // actualizo el tamaño del calendario




  });

  function calcularDias(){
    fecha_inicio = document.getElementById("fecha_inicio").value;
    fecha_fin = document.getElementById("fecha_fin").value;

    // obtener la diferencia en dias entre las dos fechas
    var fecha1 = new Date(fecha_inicio);
    var fecha2 = new Date(fecha_fin);
    var diff = fecha2.getTime() - fecha1.getTime();
    var dias = diff / (1000 * 60 * 60 * 24);
    dias = dias + 1;
    if (dias < 0){
      alert("La fecha de inicio no puede ser mayor a la fecha de fin");
      document.getElementById("fecha_inicio").value = "";
    }
      document.getElementById("dias_consumidos").value = dias;
  }
</script>

{% endblock %}